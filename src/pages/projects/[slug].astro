---
// ============================================================================
// IMPORTS - Updated to use shared components and utilities
// ============================================================================
import { getCollection } from 'astro:content';
import BaseLayout from "../../layouts/BaseLayout.astro";
import ArcCanvas from "../../components/ArcCanvas.astro";
import SiteHeader from "../../components/SiteHeader.astro";
import PageNavigation from "../../components/PageNavigation.astro";

// NEW: Import shared components
import Card from "../../components/Card.astro";
import LinkButton from "../../components/LinkButton.astro";
import StatusBadge from "../../components/StatusBadge.astro";

import '../../styles/pages/project-detail.css';
import '../../styles/pages/projects.css'; // For status badges

// NEW: Import utilities and constants
import { withBase } from '../../utils/paths';
import { buildSEO } from '../../utils/seo';
import { EXTERNAL_LINKS } from '../../config/constants';

// ============================================================================
// DYNAMIC ROUTE GENERATION
// ============================================================================
export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await project.render();

// ============================================================================
// SEO - Simplified using buildSEO utility
// ============================================================================
const seo = buildSEO({
  title: project.data.title,
  description: project.data.description,
  path: `/projects/${project.slug}`,
  siteUrl: Astro.site,
});
---

<BaseLayout title={seo.title} description={seo.description} bodyClass="page-project-detail" seo={seo}>
  <ArcCanvas />
  <SiteHeader active="projects" />

  <main id="main-content" class="page-shell project-detail-shell">
    
    <!-- BREADCRUMB - Keep as is, just using withBase utility -->
    <nav class="breadcrumb" aria-label="Breadcrumb">
      <a href={withBase("/projects")}>Projects</a>
      <span aria-hidden="true">/</span>
      <span aria-current="page">{project.data.title}</span>
    </nav>

    <!-- PROJECT HERO 
         Replace status badge with StatusBadge component -->
    <header class="project-hero">
      <div class="project-meta">
        <StatusBadge status={project.data.status} />
        <span class="project-date">Last updated: {project.data.lastUpdated}</span>
      </div>
      <h1>{project.data.title}</h1>
      <p class="project-lede">{project.data.description}</p>
    </header>

    <!-- QUICK SUMMARY PANEL 
         Replace surface-panel wrapper with Card -->
    <Card as="section" class="summary-panel">
      <h2>At a Glance</h2>
      <div class="summary-grid">
        <div class="summary-item">
          <h3>The Challenge</h3>
          <p>{project.data.challenge}</p>
        </div>
        <div class="summary-item">
          <h3>Our Approach</h3>
          <p>{project.data.approach}</p>
        </div>
        <div class="summary-item">
          <h3>Current Status</h3>
          <p>{project.data.currentStatus}</p>
        </div>
      </div>
    </Card>

    <!-- MAIN CONTENT (from markdown) 
         Keep ALL structure as-is -->
    <article class="project-content">
      
      <section class="content-section">
        <Content />
      </section>

      <section class="content-section">
        <h2>Research Questions</h2>
        <ul class="styled-list">
          {project.data.researchQuestions.map((question) => (
            <li>{question}</li>
          ))}
        </ul>
      </section>

      <section class="content-section">
        <h2>What We're Looking For</h2>
        <div class="needs-grid">
          <div class="need-item">
            <h3>Expertise</h3>
            <ul>
              {project.data.expertise.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </div>
          <div class="need-item">
            <h3>Resources</h3>
            <ul>
              {project.data.resources.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </div>
          <div class="need-item">
            <h3>Support</h3>
            <ul>
              {project.data.support.map((item) => (
                <li>{item}</li>
              ))}
            </ul>
          </div>
        </div>
      </section>

      <section class="content-section">
        <h2>Project Timeline</h2>
        <div class="timeline">
          {project.data.timeline.map((phase) => (
            <div class="timeline-item">
              <div class="timeline-marker">
                <span class="timeline-date">{phase.date}</span>
              </div>
              <div class="timeline-content">
                <h3>{phase.phase}</h3>
                <p>{phase.description}</p>
              </div>
            </div>
          ))}
        </div>
      </section>

      <section class="content-section">
        <h2>How to Contribute</h2>
        <p>There are multiple ways to get involved, regardless of your background:</p>
        <div class="contribution-cards">
          {project.data.contributions.map((contrib) => (
            <div class="contrib-card">
              <h3>{contrib.title}</h3>
              <p>{contrib.description}</p>
            </div>
          ))}
        </div>
      </section>

    </article>

    <!-- LINKS & RESOURCES 
         Replace surface-panel wrapper with Card -->
    <Card as="section" class="resources-section">
      <h2>Links & Resources</h2>
      <p class="resources-intro">As this project develops, we'll share documentation, data, and code here. For now, these links are placeholders ‚Äî real resources will be added as they're created.</p>
      
      <div class="links-grid">
        <a href="#" class="resource-link disabled">
          <div class="link-icon">üìö</div>
          <div class="link-content">
            <h3>Project Wiki</h3>
            <p>Research notes, protocols, and methodology documentation</p>
          </div>
          <span class="link-status">Coming Soon</span>
        </a>

        <a href="#" class="resource-link disabled">
          <div class="link-icon">üíª</div>
          <div class="link-content">
            <h3>GitHub Repository</h3>
            <p>Code for data analysis, sensor systems, and visualization tools</p>
          </div>
          <span class="link-status">Coming Soon</span>
        </a>

        <a href="#" class="resource-link disabled">
          <div class="link-icon">üìä</div>
          <div class="link-content">
            <h3>Open Data Repository</h3>
            <p>Raw datasets, trial results, and measurement logs</p>
          </div>
          <span class="link-status">Coming Soon</span>
        </a>

        <a href="#" class="resource-link disabled">
          <div class="link-icon">üìÑ</div>
          <div class="link-content">
            <h3>Publications & Preprints</h3>
            <p>Research papers, technical reports, and findings</p>
          </div>
          <span class="link-status">Coming Soon</span>
        </a>

        <a href="#" class="resource-link disabled">
          <div class="link-icon">üõ†Ô∏è</div>
          <div class="link-content">
            <h3>Hardware Designs (OSHW)</h3>
            <p>Schematics, CAD files, and build instructions for equipment</p>
          </div>
          <span class="link-status">Coming Soon</span>
        </a>

        <a href="#" class="resource-link disabled">
          <div class="link-icon">üí¨</div>
          <div class="link-content">
            <h3>Discussion Forum</h3>
            <p>Community discussions, Q&A, and collaboration space</p>
          </div>
          <span class="link-status">Coming Soon</span>
        </a>
      </div>

      <p class="resources-note"><strong>Note:</strong> All project outputs will be released under open licenses (CERN-OHL-S v2 for hardware, CC BY-NC-SA 4.0 for documentation, AGPL-3.0 for software).</p>
    </Card>

    <!-- JOIN CTA 
         Replace surface-panel wrapper with Card, replace buttons with LinkButton -->
    <Card as="section" class="join-cta-section">
      <h2>Join This Project</h2>
      <p>Whether you're a student, researcher, farmer, or just curious ‚Äî there's a way to contribute. The project is in early stages, which means you can help shape the direction.</p>
      <div class="cta-buttons">
        <LinkButton href={EXTERNAL_LINKS.formURL} variant="primary" icon="external">
          Get Involved
        </LinkButton>
        <LinkButton href={withBase("/projects")} variant="outline" icon="arrow-right">
          ‚Üê Back to All Projects
        </LinkButton>
      </div>
    </Card>

  </main>

  <PageNavigation currentPage="projects" />
</BaseLayout>

<!-- 
============================================================================
MIGRATION SUMMARY - projects/[slug].astro
============================================================================

‚úÖ WHAT CHANGED (Minimal, preserving design):
1. Imports:
   - Added: Card, LinkButton, StatusBadge components
   - Added: withBase, buildSEO, EXTERNAL_LINKS utilities
   - Removed: Duplicate withBase function, manual SEO construction, hard-coded formURL

2. Replaced specific elements:
   - Status badge span ‚Üí <StatusBadge status={project.data.status} />
   - <section class="surface-panel"> ‚Üí <Card as="section"> (3 instances)
   - <a class="button button--primary"> ‚Üí <LinkButton variant="primary">
   - <a class="button button--outline"> ‚Üí <LinkButton variant="outline">
   - formURL ‚Üí EXTERNAL_LINKS.formURL

‚úÖ WHAT DIDN'T CHANGE (Preserved design):
- ALL section headers kept as-is (h1, h2, h3 elements)
- Breadcrumb structure maintained
- Project hero layout unchanged
- Summary grid structure preserved
- ALL content sections unchanged (.content-section, .needs-grid, .timeline, etc.)
- Resource links grid structure maintained
- Visual appearance should be IDENTICAL

‚úÖ DYNAMIC ROUTE HANDLING:
- getStaticPaths function unchanged
- Project data structure unchanged
- Content rendering unchanged
- SEO uses dynamic project data correctly with buildSEO()

============================================================================
-->